#include <avr/io.h>
#include <stdio.h>
#include "my_atmega128.h"
#include "my_LCD.h"
#include <math.h>

double Volt_Scan(void);
unsigned char keyScan(void);


int main(void)
{
     // LED Init

    DDRC  = 0xFF;  
    PORTC = 0x00;

    // LCD Init

    DDRA  = 0xFF;
    PORTA = 0x00;


    int ADC_start;
    ADC_start = 0;
    char msg_1[16];
    char msg_2[16];
	 
    LCD_initialize();



    unsigned char Switch_N;
	double Volt_val;
   
    while(1) 
    {
        Switch_N = keyScan();

        if (Switch_N == 3)  //? ????????? S3 (???? ???)??? ??????
            ADC_start = 1;

        if (Switch_N == 7)  //? ????????? S7 ??? ??????
        {  
            ADCSRA = ADCSRA & ~(1<<7); // AD converter ??????
            ADC_start = 0;
            PORTC = 0x00;		       // LED OFF 
        }

        if(ADC_start>0)
        {
            Volt_val = Volt_Scan();

            // LCD Print message
            sprintf(msg_1, " |V1 - V2|    ");
            sprintf(msg_2, "value : %2.2f! ", Volt_val);

            LCD_string(0x80, msg_1);
            LCD_string(0xC0, msg_2);

            if(Volt_val > 2.0)      // ????????? 2.0 volt ?????? (??????? (AREF/2) * 0.8 ??????) 
                PORTC = 0xFF;
            else
                PORTC = 0x00;
        }
    }
}

unsigned char keyScan(void) {
    unsigned char keyNum = 0;

    // SAVE ORIGINAL STATE
    unsigned char ddre  = DDRE;
    unsigned char porte = PORTE;

    // DDR*  : ???? ???”³?? ??????? ???????? (0 = ??????? ???, 1 = ??????? ???)
    // PORT* : ???? ??¢¯????? ????? ?? ??¡Æ??? ???? ???????? (0 = ??¨ú???, 1 = ?????)
    // PIN*  : ???? ??¢¯????? ????? ?? ??¡Æ??? ??? ????????

    // 0x00?? 16???????? 1?? ??????? ???? ????? ???? ??? ?????,
    // 16?? ?????(??????? 0x*0?? *?¥ê?)?? key_scan/key_data ???? ?????? 4???? ??????.

    DDRE  |= 0xF0; // key_scan ?? ???? 4???? ??? ??????? ????
    PORTE &= 0x0F; // key_scan ?? ????? 4 ???? ?????? ??? ???? 0???? ????

    unsigned char i, j;
    for (i = 0; i < 4; i++) {
        PORTE |= (0x10 << i); // (1) key_scan ?? i??¡Æ ??? ??¡Æ??? 1?? ????, ???????? ??? ????.
        Delay_us(5);
        
        for (j = 0; j < 4; j++)
        {
            if (PIND & (0x10 << j)) // (2) key_data ?? j??¡Æ ??? 1?? ????????? ???
            {
                // (3) key_data ??? ??? ????? ??¥å??, (1) ????? ????? key_scan ?? ?????
                //     ????? ?????? key_data ?? ????? ?????? ???? ????? ????? ???? ?? ????.
                keyNum = 3 + (4 * i) + j; // ??????? S3???? ???????? 3?? ????? ??????.
            }
        }

        PORTE &= ~(0x10 << i); // (4) key_scan ?? i??¡Æ ??? ??¡Æ??? ??? 0???? ?????.
    }

    // ROLL BACK
    DDRE  = ddre;
    PORTE = porte;

    return keyNum;
}

double Volt_Scan(void){
    double volt_1;
    double volt_2;
    double volt_dif;
    
    ADMUX = 0x00;

    ADCSRA = 0xF7;  
    Delay_ms(10);	

    while((ADCSRA&0x10)==0);  // AD conversion?? ??? ?????? ??? (???? ???)
            
    ADCSRA |= 0x10;   // AD conversion?? ??? ??????? ????? clear

    volt_1 = ADC / 1023.0F * 5;
    
    ADCSRA &= ~(1<<7); // AD converter ??????

    Delay_ms(5);

    ADMUX = 0x01;

    ADCSRA = 0xF7;  
    Delay_ms(10);	

    while((ADCSRA&0x10)==0);  // AD conversion?? ??? ?????? ??? (???? ???)
            
    ADCSRA |= 0x10;   // AD conversion?? ??? ??????? ????? clear

    volt_2 = ADC / 1023.0F * 5;
    
    ADCSRA &= ~(1<<7); // AD converter ??????

	
	volt_dif = volt_1 - volt_2;

    return fabs(volt_dif);
} 

